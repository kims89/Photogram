<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity3" xmlns:width="http://www.w3.org/1999/xhtml">
<head>
    <meta id="token" name="_csrf" th:content="${_csrf.token}"/>
    <meta id="headerName" name="_csrf_header" th:content="${_csrf.headerName}"/>

    <script src="/res/jquery-3.1.1.min.js"></script>
    <script src="/res/jquery.easy-autocomplete.js"></script>
    <link rel="stylesheet" href="/res/easy-autocomplete.min.css" />

    <script src="/res/tether.min.js"></script><!-- Tether for Bootstrap. Nødvendig for at Bootstrap skal fungere optimalt -->
    <link rel="stylesheet" href="/res/bootstrap.css"/>
    <script src="/res/bootstrap.js" ></script>



    <script>
                /*<![CDATA[*/

                function refreshSite() {
                    $( "#refreshSite" ).load( "/photoadmin" );

                }

                function deleteBildefil(ele){
                    var parentId = ele.parentNode.id;
                    var token = document.getElementById("token").getAttribute("content");
                    var headerName = document.getElementById("headerName").getAttribute("content");
                    console.log("Logg: "+ parentId);
                    var xmlHttp = new XMLHttpRequest();
                    xmlHttp.onreadystatechange = function(){
                        if(xmlHttp.readyState == 4 && xmlHttp.status == 200){
                            div = document.getElementById("fotograflak");
                            div.removeChild(ele.parentNode);
                        }
                    };

                    xmlHttp.open("POST", "/delete/"+parentId, true);
                    xmlHttp.setRequestHeader("content-type", "application/x-www-form-urlencoded");
                    xmlHttp.setRequestHeader(headerName, token);
                    xmlHttp.send();
                }

                $(document).ready(function () {
                    var options = {
                        url: "/sok",

                        getValue: "sok",


                        list: {
                            match: {
                                enabled: true
                            },
                            hideAnimation: {
                                type: "slide", //normal|slide|fade
                                time: 400,
                                callback: function() {}
                            }
                        },
                        template: {
                            type: "links",
                            fields: {
                                link: "url"
                            }
                        }
                    };

                    $("#template-links").easyAutocomplete(options);

                });
        /*]]>*/
    </script>
    <title>Title</title>
</head>
<body>
<div id="refreshSite">
<!-- Main jumbotron for a primary marketing message or call to action -->
<div class="jumbotron">
    <div class="container">
        <h1>Fotograf</h1>
        <div class="alert alert-success" role="alert">Her kan du enkelt legge ut bilder med metadata.</div>
        <div class="row">
            <div class="col-md-4">
                <form id="data">
                    <div class="form-group"><input type="text" class="form-control" name="tittel" id="tittel" placeholder="Tittel" /></div>
                    <div class="form-group"><input type="text" class="form-control" name="dato" id="dato" placeholder="Dato (22.04.2016)" /></div>
                    <div class="form-group"><input type="text" class="form-control" name="tag" id="tag" placeholder="#Tagg" /></div>
                    <p><div class="form-group"><label class="btn btn-default btn-file">Last opp foto<input name="bild" id="bild" type="file" style="display: none;" /></label>
                   <input class="btn btn-primary" type="submit" value="Publiser"/></div></p>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="row" id="fotograflak">
        <div class="col-lg-4" th:each="p : ${photo}" th:id="${p.id}">
            <br/>
            <img th:src="${p.filnavn}" class="media-object" width="350" />
            <h2 th:text="${p.tittel}"></h2>

            <button class="btn btn-danger btn-sm" onClick="deleteBildefil(this);">Slett bilde</button>
            <button class="btn btn-warning btn-sm" onClick="">Endre</button>
        </div>

    </div>
</div>
<script>
    /*<![CDATA[*/

    //Program a custom submit function for the form
    $("form#data").submit(function(event){
        //disable the default form submission
        event.preventDefault();
        var tittel = $( "#tittel" ).val();
        bilde = document.getElementById("bild").files[0].name;

        //grab all form data
        var formData = new FormData($(this)[0]);
        $.ajax({

            url: '/PAAddPhoto',
            type: 'POST',
            data: formData,
            async: false,
            cache: false,
            contentType: false,
            headers: {
                'X-CSRF-Token': $('meta[name="_csrf"]').attr('content'),
                'X-CSRF-headerName': $('meta[name="_csrf_header"]').attr('content')
            },
            processData: false,
            success: function (returndata) {
                $("#fotograflak").append("<div class='col-lg-4'><br/><img src='/files/"+bilde+"' class='media-object' width='350' />" +
                        "<h2>"+tittel+"</h2>" +
                        "<p><small>Donec id elit non mi porta gravida at eget metus. Fusce dapibus, tellus ac cursus commodo, tortor mauris condimentum nibh, ut fermentum massa justo sit amet risus. Etiam porta sem malesuada magna mollis euismod. Donec sed odio dui. </small></p>" +
                        "<div class='alert alert-warning' role='alert'><a onclick='refreshSite()' class='alert-link'>Oppdater</a> for å slette og endre</div></div>");
            },
            error: function() {
                alert('Error!');
            }
        });
        return false;
    });

    /*]]>*/
</script>
&nbsp;
<div class="container">
    <p><input id="template-links" placeholder="Søk" /></p>
    <p><a class="btn btn-primary btn-lg" href="#" role="button">KNAPP &raquo;</a>
        <a class="btn btn-primary btn-lg" href="#" role="button">KNAPP &raquo;</a></p>
</div>
</div>
</body>
</html>